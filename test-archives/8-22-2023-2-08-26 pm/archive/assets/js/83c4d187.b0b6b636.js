"use strict";(self.webpackChunkplaywright_dev=self.webpackChunkplaywright_dev||[]).push([[4019],{3905:function(e,t,a){a.d(t,{Zo:function(){return c},kt:function(){return h}});var n=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var i=n.createContext({}),p=function(e){var t=n.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(i.Provider,{value:t},e.children)},u="mdxType",g={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,i=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(a),d=o,h=u["".concat(i,".").concat(d)]||u[d]||g[d]||r;return a?n.createElement(h,s(s({ref:t},c),{},{components:a})):n.createElement(h,s({ref:t},c))}));function h(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,s=new Array(r);s[0]=d;var l={};for(var i in t)hasOwnProperty.call(t,i)&&(l[i]=t[i]);l.originalType=e,l[u]="string"==typeof e?e:o,s[1]=l;for(var p=2;p<r;p++)s[p]=a[p];return n.createElement.apply(null,s)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},7252:function(e,t,a){a.r(t),a.d(t,{assets:function(){return m},contentTitle:function(){return d},default:function(){return b},frontMatter:function(){return g},metadata:function(){return h},toc:function(){return f}});var n=a(3905),o=Object.defineProperty,r=Object.defineProperties,s=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,c=(e,t,a)=>t in e?o(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,u=(e,t)=>{for(var a in t||(t={}))i.call(t,a)&&c(e,a,t[a]);if(l)for(var a of l(t))p.call(t,a)&&c(e,a,t[a]);return e};const g={id:"test-global-setup-teardown",title:"Global setup and teardown"},d=void 0,h={unversionedId:"test-global-setup-teardown",id:"version-stable/test-global-setup-teardown",title:"Global setup and teardown",description:"There are two ways to configure global setup and teardown: using a global setup file and setting it in the config under globalSetup or using project dependencies. With project dependencies, you define a project that runs before all other projects. This is the recommended way to configure global setup as with Project dependencies your HTML report will show the global setup, trace viewer will record a trace of the setup and fixtures can be used.",source:"@site/versioned_docs/version-stable/test-global-setup-teardown.mdx",sourceDirName:".",slug:"/test-global-setup-teardown",permalink:"/docs/test-global-setup-teardown",draft:!1,tags:[],version:"stable",frontMatter:{id:"test-global-setup-teardown",title:"Global setup and teardown"},sidebar:"docs",previous:{title:"Fixtures",permalink:"/docs/test-fixtures"},next:{title:"Parallelism",permalink:"/docs/test-parallel"}},m={},f=[{value:"Project Dependencies",id:"project-dependencies",level:2},{value:"Setup",id:"setup",level:3},{value:"Setup Example",id:"setup-example",level:3},{value:"Teardown",id:"teardown",level:3},{value:"Teardown Example",id:"teardown-example",level:3},{value:"Configure globalSetup and globalTeardown",id:"configure-globalsetup-and-globalteardown",level:2},{value:"Example",id:"example",level:3},{value:"Capturing trace of failures during global setup",id:"capturing-trace-of-failures-during-global-setup",level:3}],w={toc:f};function b(e){var t,a=e,{components:o}=a,c=((e,t)=>{var a={};for(var n in e)i.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&l)for(var n of l(e))t.indexOf(n)<0&&p.call(e,n)&&(a[n]=e[n]);return a})(a,["components"]);return(0,n.kt)("wrapper",(t=u(u({},w),c),r(t,s({components:o,mdxType:"MDXLayout"}))),(0,n.kt)("p",null,"There are two ways to configure global setup and teardown: using a global setup file and setting it in the config under ",(0,n.kt)("a",u({parentName:"p"},{href:"#configure-globalsetup-and-globalteardown"}),(0,n.kt)("inlineCode",{parentName:"a"},"globalSetup"))," or using ",(0,n.kt)("a",u({parentName:"p"},{href:"#project-dependencies"}),"project dependencies"),". With project dependencies, you define a project that runs before all other projects. This is the recommended way to configure global setup as with Project dependencies your HTML report will show the global setup, trace viewer will record a trace of the setup and fixtures can be used."),(0,n.kt)("h2",u({},{id:"project-dependencies"}),"Project Dependencies"),(0,n.kt)("p",null,(0,n.kt)("a",u({parentName:"p"},{href:"./api/class-testproject#test-project-dependencies"}),"Project dependencies")," are a list of projects that need to run before the tests in another project run. They can be useful for configuring the global setup actions so that one project depends on this running first. Using dependencies allows global setup to produce traces and other artifacts."),(0,n.kt)("h3",u({},{id:"setup"}),"Setup"),(0,n.kt)("p",null,"First we add a new project with the name 'setup'. We then give it a ",(0,n.kt)("a",u({parentName:"p"},{href:"/docs/api/class-testproject#test-project-test-match"}),"testProject.testMatch")," property in order to match the file called ",(0,n.kt)("inlineCode",{parentName:"p"},"global.setup.ts"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js",metastring:'title="playwright.config.ts"',title:'"playwright.config.ts"'}),"import { defineConfig } from '@playwright/test';\n\nexport default defineConfig({\n  projects: [\n    {\n      name: 'setup',\n      testMatch: /global.setup\\.ts/,\n    },\n    // {\n    //   other project\n    // }\n  ]\n});\n")),(0,n.kt)("p",null,"Then we add the ",(0,n.kt)("a",u({parentName:"p"},{href:"/docs/api/class-testproject#test-project-dependencies"}),"testProject.dependencies")," property to our projects that depend on the setup project and pass into the array the name of of our dependency project, which we defined in the previous step:"),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js",metastring:'title="playwright.config.ts"',title:'"playwright.config.ts"'}),"import { defineConfig } from '@playwright/test';\n\nexport default defineConfig({\n  projects: [\n    {\n      name: 'setup',\n      testMatch: /global.setup\\.ts/,\n    },\n    {\n      name: 'chromium',\n      use: { ...devices['Desktop Chrome'] },\n      dependencies: ['setup'],\n    },\n  ]\n});\n")),(0,n.kt)("h3",u({},{id:"setup-example"}),"Setup Example"),(0,n.kt)("p",null,"This example will show you how to use project dependencies to create a global setup that logins into an application and saves the state in storage state. This is useful if you want to run multiple tests that require a sign sign-in state and you want to avoid login for each test."),(0,n.kt)("p",null,"The setup project will write the storage state into an 'playwright/.auth/user.json' file next to your playwright.config. By exporting a const of ",(0,n.kt)("inlineCode",{parentName:"p"},"STORAGE_STATE")," we can then easily share the location of the storage file between projects with the ",(0,n.kt)("a",u({parentName:"p"},{href:"./test-use-options#basic-options"}),(0,n.kt)("inlineCode",{parentName:"a"},"StorageState"))," method. This applies the storage state on the browser context with its cookies and a local storage snapshot."),(0,n.kt)("p",null,"In this example the 'logged in chromium' project depends on the setup project whereas the 'logged out chromium' project does not depend on the setup project, and does not use the ",(0,n.kt)("inlineCode",{parentName:"p"},"storageState")," option."),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js",metastring:'title="playwright.config.ts"',title:'"playwright.config.ts"'}),"import { defineConfig } from '@playwright/test';\n\nexport const STORAGE_STATE = path.join(__dirname, 'playwright/.auth/user.json');\n\nexport default defineConfig({\n  use: {\n    baseURL: 'http://localhost:3000/',\n  },\n  projects: [\n    {\n      name: 'setup',\n      testMatch: /global.setup\\.ts/,\n    },\n    {\n      name: 'logged in chromium',\n      testMatch: '**/*.loggedin.spec.ts',\n      dependencies: ['setup'],\n      use: {\n        ...devices['Desktop Chrome'],\n        storageState: STORAGE_STATE,\n      },\n    },\n    {\n      name: 'logged out chromium',\n      use: { ...devices['Desktop Chrome'] },\n      testIgnore: ['**/*loggedin.spec.ts']\n    },\n  ],\n});\n")),(0,n.kt)("p",null,"We then create a setup test, stored at root level of your project, that logs in to an application and populates the context with the storage state after the login actions have been performed. By doing this you only have to log in once and the credentials will be stored in the ",(0,n.kt)("inlineCode",{parentName:"p"},"STORAGE_STATE")," file, meaning you don't need to log in again for every test. Start by importing the ",(0,n.kt)("inlineCode",{parentName:"p"},"STORAGE_STATE")," from the Playwright config file and then use this as the path to save your storage state to the page's context."),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js",metastring:'title="global.setup.ts"',title:'"global.setup.ts"'}),"import { test as setup, expect } from '@playwright/test';\nimport { STORAGE_STATE } from '../playwright.config';\n\nsetup('do login', async ({ page }) => {\n  await page.goto('/');\n  await page.getByLabel('User Name').fill('user');\n  await page.getByLabel('Password').fill('password');\n  await page.getByText('Sign in').click();\n\n  // Wait until the page actually signs in.\n  await expect(page.getByText('Hello, user!')).toBeVisible();\n\n  await page.context().storageState({ path: STORAGE_STATE });\n});\n")),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js",metastring:'title="tests/menu.loggedin.spec.ts"',title:'"tests/menu.loggedin.spec.ts"'}),"import { test, expect } from '@playwright/test';\n\ntest.beforeEach(async ({ page }) => {\n  await page.goto('/');\n});\n\ntest('menu', async ({ page }) => {\n  // You are signed in!\n});\n")),(0,n.kt)("p",null,"For a more detailed example check out our blog post: ",(0,n.kt)("a",u({parentName:"p"},{href:"https://dev.to/playwright/a-better-global-setup-in-playwright-reusing-login-with-project-dependencies-14"}),"A better global setup in Playwright reusing login with project dependencies")," or check the ",(0,n.kt)("a",u({parentName:"p"},{href:"https://youtu.be/PI50YAPTAs4"}),"v1.31 release video")," to see the demo."),(0,n.kt)("h3",u({},{id:"teardown"}),"Teardown"),(0,n.kt)("p",null,"You can teardown your setup by adding a ",(0,n.kt)("a",u({parentName:"p"},{href:"/docs/api/class-testproject#test-project-teardown"}),"testProject.teardown")," property to your setup project. This will run after all dependent projects have run."),(0,n.kt)("p",null,"First we add a new project into the projects array and give it a name such as 'cleanup db'. We then give it a ",(0,n.kt)("a",u({parentName:"p"},{href:"/docs/api/class-testproject#test-project-test-match"}),"testProject.testMatch")," property in order to match the file called ",(0,n.kt)("inlineCode",{parentName:"p"},"global.teardown.ts"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js",metastring:'title="playwright.config.ts"',title:'"playwright.config.ts"'}),"import { defineConfig } from '@playwright/test';\n\nexport default defineConfig({\n  projects: [\n    // {\n    //   setup project\n    // },\n    {\n      name: 'cleanup db',\n      testMatch: /global.teardown\\.ts/,\n    },\n    // {\n    //   other project\n    // }\n  ]\n});\n")),(0,n.kt)("p",null,"Then we add the ",(0,n.kt)("a",u({parentName:"p"},{href:"/docs/api/class-testproject#test-project-teardown"}),"testProject.teardown")," property to our setup project with the name 'cleanup db' which is the name we gave to our teardown project in the previous step:"),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js",metastring:'title="playwright.config.ts"',title:'"playwright.config.ts"'}),"import { defineConfig } from '@playwright/test';\n\nexport default defineConfig({\n  projects: [\n    {\n      name: 'setup db',\n      testMatch: /global\\.setup\\.ts/,\n      teardown: 'cleanup db',\n    },\n    {\n      name: 'cleanup db',\n      testMatch: /global\\.teardown\\.ts/,\n    },\n    // {\n    //   other project\n    // }\n  ]\n});\n")),(0,n.kt)("h3",u({},{id:"teardown-example"}),"Teardown Example"),(0,n.kt)("p",null,"Start by creating a ",(0,n.kt)("inlineCode",{parentName:"p"},"global.setup.ts")," file at the root level of your project. This will be used to seed the database with some data before all tests have run."),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js",metastring:'title="global.setup.ts"',title:'"global.setup.ts"'}),"// seed the database with some data\n")),(0,n.kt)("p",null,"Then create a ",(0,n.kt)("inlineCode",{parentName:"p"},"global.teardown.ts")," file at the root level of your project. This will be used to delete the data from the database after all tests have run."),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js",metastring:'title="global.teardown.ts"',title:'"global.teardown.ts"'}),"// delete the data from the database\n")),(0,n.kt)("p",null,"In the Playwright config file:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Add a project into the projects array and give it a name such as 'setup db'. Give it a ",(0,n.kt)("a",u({parentName:"li"},{href:"/docs/api/class-testproject#test-project-test-match"}),"testProject.testMatch")," property in order to match the file called ",(0,n.kt)("inlineCode",{parentName:"li"},"global.setup.ts"),"."),(0,n.kt)("li",{parentName:"ul"},"Create another project and give it a name such as 'cleanup db'. Give it a ",(0,n.kt)("a",u({parentName:"li"},{href:"/docs/api/class-testproject#test-project-test-match"}),"testProject.testMatch")," property in order to match the file called ",(0,n.kt)("inlineCode",{parentName:"li"},"global.teardown.ts"),"."),(0,n.kt)("li",{parentName:"ul"},"Add the ",(0,n.kt)("a",u({parentName:"li"},{href:"/docs/api/class-testproject#test-project-teardown"}),"testProject.teardown")," property to our setup project with the name 'cleanup db' which is the name given to our teardown project in the previous step. Finally add the 'chromium' project with the ",(0,n.kt)("a",u({parentName:"li"},{href:"/docs/api/class-testproject#test-project-dependencies"}),"testProject.dependencies")," on the 'setup db' project.")),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js",metastring:'title="playwright.config.ts"',title:'"playwright.config.ts"'}),"import { defineConfig } from '@playwright/test';\n\nexport default defineConfig({\n  projects: [\n    {\n      name: 'setup db',\n      testMatch: /global\\.setup\\.ts/,\n      teardown: 'cleanup db',\n    },\n    {\n      name: 'cleanup db',\n      testMatch: /global\\.teardown\\.ts/,\n    },\n    {\n      name: 'chromium',\n      use: { ...devices['Desktop Chrome'] },\n      dependencies: ['setup db'],\n    },\n  ]\n});\n")),(0,n.kt)("h2",u({},{id:"configure-globalsetup-and-globalteardown"}),"Configure globalSetup and globalTeardown"),(0,n.kt)("p",null,"You can use the ",(0,n.kt)("inlineCode",{parentName:"p"},"globalSetup")," option in the ",(0,n.kt)("a",u({parentName:"p"},{href:"/docs/test-configuration#advanced-configuration"}),"configuration file")," to set something up once before running all tests. The global setup file must export a single function that takes a config object. This function will be run once before all the tests."),(0,n.kt)("p",null,"Similarly, use ",(0,n.kt)("inlineCode",{parentName:"p"},"globalTeardown")," to run something once after all the tests. Alternatively, let ",(0,n.kt)("inlineCode",{parentName:"p"},"globalSetup")," return a function that will be used as a global teardown. You can pass data such as port number, authentication tokens, etc. from your global setup to your tests using environment variables."),(0,n.kt)("admonition",u({},{type:"note"}),(0,n.kt)("p",{parentName:"admonition"},"Using ",(0,n.kt)("inlineCode",{parentName:"p"},"globalSetup")," and ",(0,n.kt)("inlineCode",{parentName:"p"},"globalTeardown")," will not produce traces or artifacts. If you want to produce traces and artifacts, use ",(0,n.kt)("a",u({parentName:"p"},{href:"#project-dependencies"}),"project dependencies"),".")),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js",metastring:'title="playwright.config.ts"',title:'"playwright.config.ts"'}),"import { defineConfig } from '@playwright/test';\n\nexport default defineConfig({\n  globalSetup: require.resolve('./global-setup'),\n  globalTeardown: require.resolve('./global-teardown'),\n});\n")),(0,n.kt)("h3",u({},{id:"example"}),"Example"),(0,n.kt)("p",null,"Here is a global setup example that authenticates once and reuses authentication state in tests. It uses the ",(0,n.kt)("inlineCode",{parentName:"p"},"baseURL")," and ",(0,n.kt)("inlineCode",{parentName:"p"},"storageState")," options from the configuration file."),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js",metastring:'title="global-setup.ts"',title:'"global-setup.ts"'}),"import { chromium, type FullConfig } from '@playwright/test';\n\nasync function globalSetup(config: FullConfig) {\n  const { baseURL, storageState } = config.projects[0].use;\n  const browser = await chromium.launch();\n  const page = await browser.newPage();\n  await page.goto(baseURL!);\n  await page.getByLabel('User Name').fill('user');\n  await page.getByLabel('Password').fill('password');\n  await page.getByText('Sign in').click();\n  await page.context().storageState({ path: storageState as string });\n  await browser.close();\n}\n\nexport default globalSetup;\n")),(0,n.kt)("p",null,"Specify ",(0,n.kt)("inlineCode",{parentName:"p"},"globalSetup"),", ",(0,n.kt)("inlineCode",{parentName:"p"},"baseURL")," and ",(0,n.kt)("inlineCode",{parentName:"p"},"storageState")," in the configuration file."),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js",metastring:'title="playwright.config.ts"',title:'"playwright.config.ts"'}),"import { defineConfig } from '@playwright/test';\nexport default defineConfig({\n  globalSetup: require.resolve('./global-setup'),\n  use: {\n    baseURL: 'http://localhost:3000/',\n    storageState: 'state.json',\n  },\n});\n")),(0,n.kt)("p",null,"Tests start already authenticated because we specify ",(0,n.kt)("inlineCode",{parentName:"p"},"storageState")," that was populated by global setup."),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js"}),"import { test } from '@playwright/test';\n\ntest('test', async ({ page }) => {\n  await page.goto('/');\n  // You are signed in!\n});\n")),(0,n.kt)("p",null,"You can make arbitrary data available in your tests from your global setup file by setting them as environment variables via ",(0,n.kt)("inlineCode",{parentName:"p"},"process.env"),"."),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js",metastring:'title="global-setup.ts"',title:'"global-setup.ts"'}),"import type { FullConfig } from '@playwright/test';\n\nasync function globalSetup(config: FullConfig) {\n  process.env.FOO = 'some data';\n  // Or a more complicated data structure as JSON:\n  process.env.BAR = JSON.stringify({ some: 'data' });\n}\n\nexport default globalSetup;\n")),(0,n.kt)("p",null,"Tests have access to the ",(0,n.kt)("inlineCode",{parentName:"p"},"process.env")," properties set in the global setup."),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js"}),"import { test } from '@playwright/test';\n\ntest('test', async ({ page }) => {\n  // environment variables which are set in globalSetup are only available inside test().\n  const { FOO, BAR } = process.env;\n\n  // FOO and BAR properties are populated.\n  expect(FOO).toEqual('some data');\n\n  const complexData = JSON.parse(BAR);\n  expect(BAR).toEqual({ some: 'data' });\n});\n")),(0,n.kt)("h3",u({},{id:"capturing-trace-of-failures-during-global-setup"}),"Capturing trace of failures during global setup"),(0,n.kt)("p",null,"In some instances, it may be useful to capture a trace of failures encountered during the global setup. In order to do this, you must ",(0,n.kt)("a",u({parentName:"p"},{href:"/docs/api/class-tracing#tracing-start"}),"start tracing")," in your setup, and you must ensure that you ",(0,n.kt)("a",u({parentName:"p"},{href:"/docs/api/class-tracing#tracing-stop"}),"stop tracing")," if an error occurs before that error is thrown. This can be achieved by wrapping your setup in a ",(0,n.kt)("inlineCode",{parentName:"p"},"try...catch")," block.  Here is an example that expands the global setup example to capture a trace."),(0,n.kt)("pre",null,(0,n.kt)("code",u({parentName:"pre"},{className:"language-js",metastring:'title="global-setup.ts"',title:'"global-setup.ts"'}),"import { chromium, type FullConfig } from '@playwright/test';\n\nasync function globalSetup(config: FullConfig) {\n  const { baseURL, storageState } = config.projects[0].use;\n  const browser = await chromium.launch();\n  const context = await browser.newContext();\n  const page = await context.newPage();\n  try {\n    await context.tracing.start({ screenshots: true, snapshots: true });\n    await page.goto(baseURL!);\n    await page.getByLabel('User Name').fill('user');\n    await page.getByLabel('Password').fill('password');\n    await page.getByText('Sign in').click();\n    await context.storageState({ path: storageState as string });\n    await context.tracing.stop({\n      path: './test-results/setup-trace.zip',\n    });\n    await browser.close();\n  } catch (error) {\n    await context.tracing.stop({\n      path: './test-results/failed-setup-trace.zip',\n    });\n    await browser.close();\n    throw error;\n  }\n}\n\nexport default globalSetup;\n")))}b.isMDXComponent=!0}}]);